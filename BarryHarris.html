<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Barry Harris Logic Engine</title>
    <style>
        /* --- STILE BEBOP (CSS) --- */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --tonic-color: #4CAF50;    /* Verde per la casa/riposo */
            --dim-color: #FF5722;      /* Arancio per la tensione/diminuito */
            --key-white: #e0e0e0;
            --key-black: #333;
        }

        body {
            font-family: 'Courier New', monospace; /* Monospaziato come uno spartito */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--text-color); }
        .subtitle { font-style: italic; opacity: 0.8; margin-bottom: 30px; }

        /* CONTROLLI */
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
            background: #252525;
        }

        /* NAVIGAZIONE STANZE */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-btn { background: #444; border: 1px solid #666; opacity: 0.6; }
        .nav-btn.active { background: var(--tonic-color); color: white; opacity: 1; border-color: white; }
        .room-section { display: none; width: 100%; flex-direction: column; align-items: center; }

        select, button {
            padding: 10px 20px;
            font-size: 16px;
            background: var(--key-black);
            color: var(--text-color);
            border: 1px solid #555;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover { background: #444; }

        /* LA GRIGLIA ARMONICA (8 NOTE) */
        .scale-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 steps per la scala BH */
            gap: 10px;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 40px;
        }

        .chord-card {
            background: #333;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
            border-top: 5px solid #555;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .chord-card:hover { transform: translateY(-5px); }

        /* Classi dinamiche per Tensione/Risoluzione */
        .type-tonic { border-top-color: var(--tonic-color); }
        .type-dim { border-top-color: var(--dim-color); }

        .chord-name { font-size: 1.2em; font-weight: bold; display: block; margin-bottom: 5px; }
        .chord-func { font-size: 0.8em; opacity: 0.7; text-transform: uppercase; }
        .chord-notes { font-size: 0.8em; margin-top: 10px; color: #aaa; }

        /* VISUALIZZATORE CHITARRA (TAB) */
        .fretboard-display {
            width: 100%;
            max-width: 600px;
            background: #222;
            padding: 20px;
            border: 1px solid #444;
            position: relative;
        }

        .tab-line {
            border-bottom: 1px solid #666;
            height: 25px;
            position: relative;
            z-index: 5;
        }
        
        .tab-note {
            position: absolute;
            background: var(--text-color);
            color: var(--bg-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            font-size: 12px;
            top: -12px;
            z-index: 10;
        }
        
        #tab-visualizer {
            position: relative;
            padding-bottom: 25px; /* Spazio per i numeri */
        }
        .fret-line {
            position: absolute;
            top: 0;
            height: 100px; /* 4 corde * 25px */
            width: 1px;
            background: #333;
            z-index: 0;
        }
        .fret-number {
            position: absolute;
            top: 105px;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            font-family: sans-serif;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .scale-container { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

    <h1>Bebop Logic Engine</h1>
    <div class="subtitle">"God's logic on a web page. Dig it."</div>

    <!-- NAVIGAZIONE -->
    <div class="nav-bar">
        <button onclick="openRoom(1)" id="btn-room-1" class="nav-btn active">STANZA 1: Logic Engine</button>
        <button onclick="openRoom(2)" id="btn-room-2" class="nav-btn">STANZA 2: Family Finder</button>
        <button onclick="openRoom(3)" id="btn-room-3" class="nav-btn">STANZA 3: Rhythm Boss</button>
    </div>

    <!-- STANZA 1: LOGIC ENGINE -->
    <div id="room-1" class="room-section" style="display: flex;">
        <div class="controls">
        <label>KEY (TONALITÀ): </label>
        <select id="keySelect">
            <option value="C">C</option>
            <option value="Db">Db</option>
            <option value="D">D</option>
            <option value="Eb">Eb</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="Gb">Gb</option>
            <option value="G">G</option>
            <option value="Ab">Ab</option>
            <option value="A">A</option>
            <option value="Bb">Bb</option>
            <option value="B">B</option>
        </select>
        
        <label>SCALE TYPE: </label>
        <select id="scaleType">
            <option value="major6">Major 6 Diminished</option>
            <option value="minor6">Minor 6 Diminished</option>
        </select>

        <label>STRING SET: </label>
        <select id="stringSet">
            <option value="top">Top 4 (1-2-3-4)</option>
            <option value="middle">Middle 4 (2-3-4-5)</option>
            <option value="bottom">Bottom 4 (3-4-5-6)</option>
        </select>

        <button onclick="renderScale()">CALCULATE LOGIC</button>
        <button onclick="playScale()" style="border-color: #4CAF50; color: #4CAF50;">PLAY SCALE</button>
        </div>

        <div id="scaleGrid" class="scale-container">
        </div>
    </div>

    <!-- STANZA 2: FAMILY FINDER -->
    <div id="room-2" class="room-section">
        <div class="controls" style="border-color: var(--dim-color);">
            <h3 style="margin-top:0; color: var(--dim-color);">IL RADAR DEI PARENTI</h3>
            <p style="font-size: 0.8em; max-width: 600px; margin-bottom: 20px;">
                Seleziona un accordo Diminuito (Genitore). Il sistema mostrerà i 4 accordi Dominanti (Figli) generati abbassando una singola nota.
            </p>
            <label>DIMINISHED PARENT: </label>
            <select id="dimSelect">
                <!-- Popolato via JS -->
            </select>
            <button onclick="renderFamily()">TROVA PARENTI</button>
        </div>

        <div id="familyGrid" class="scale-container" style="grid-template-columns: repeat(5, 1fr);">
            <!-- Griglia Famiglia -->
        </div>
    </div>

    <!-- STANZA 3: RHYTHM IS THE BOSS -->
    <div id="room-3" class="room-section">
        <div class="controls" style="border-color: #E91E63;">
            <h3 style="margin-top:0; color: #E91E63;">RHYTHM IS THE BOSS</h3>
            <p style="font-size: 0.8em; max-width: 600px; margin-bottom: 20px;">
                Il Jazz vive sul 2 e sul 4. Il metronomo suonerà solo su questi battiti.<br>
                <span style="color: #ff5252;">ATTENZIONE:</span> Se suoni sull'1 o sul 3, lo schermo diventerà rosso!
            </p>
            
            <div style="display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 15px;">
                <label>BPM: <span id="bpmDisplay" style="font-weight:bold; color:#E91E63;">100</span></label>
                <input type="range" id="bpmSlider" min="40" max="200" value="100" oninput="updateBpm(this.value)" style="cursor: pointer;">
            </div>

            <button id="btnMetronome" onclick="toggleMetronome()" style="border-color: #E91E63; color: #E91E63;">START SWING</button>
        </div>

        <div id="rhythmVisualizer" style="display: flex; gap: 20px; margin-top: 20px;">
            <div class="beat-indicator" id="beat-1">1</div>
            <div class="beat-indicator" id="beat-2">2</div>
            <div class="beat-indicator" id="beat-3">3</div>
            <div class="beat-indicator" id="beat-4">4</div>
        </div>
    </div>

    <div class="fretboard-display">
        <h3>VISUALIZZATORE (Drop 2)</h3>
        <p id="tab-instruction">Clicca su un accordo sopra per vederlo qui.</p>
        <div id="tab-visualizer">
            <div class="tab-line" id="string-e"></div>
            <div class="tab-line" id="string-b"></div>
            <div class="tab-line" id="string-g"></div>
            <div class="tab-line" id="string-d"></div>
            <div class="tab-line" id="string-a"></div>
            <div class="tab-line" id="string-E"></div>
        </div>
    </div>

    <script>
        /* --- LOGICA BARRY HARRIS (JS) --- */

        // Costanti Musicali
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Intervalli Scale Barry Harris (8 note)
        const INTERVALS = {
            major6: [0, 2, 4, 5, 7, 8, 9, 11], // 1, 2, 3, 4, 5, b6, 6, 7
            minor6: [0, 2, 3, 5, 7, 8, 9, 11]  // 1, 2, b3, 4, 5, b6, 6, 7
        };

        const MAX_FRETS = 20;

        // Forme di Riferimento in DO (C) - Drop 2 (Corde 1-2-3-4)
        const REF_SHAPES = {
            major6: [
                { type: 'tonic', tab: [5,5,5,5], suffix: '6' },       // C6
                { type: 'dim',   tab: [7,6,7,6], suffix: 'dim7' },    // Ddim7
                { type: 'tonic', tab: [8,8,9,7], suffix: '6' },       // C6/E
                { type: 'dim',   tab: [10,9,10,9], suffix: 'dim7' },  // Fdim7
                { type: 'tonic', tab: [12,13,12,10], suffix: '6' },   // C6/G
                { type: 'dim',   tab: [13,12,13,12], suffix: 'dim7' },// Abdim7
                { type: 'tonic', tab: [15,17,14,14], suffix: '6' },   // C6/A
                { type: 'dim',   tab: [16,15,16,15], suffix: 'dim7' } // Bdim7
            ],
            minor6: [
                { type: 'tonic', tab: [5,4,5,5], suffix: 'm6' },      // Cm6
                { type: 'dim',   tab: [7,6,7,6], suffix: 'dim7' },    // Ddim7
                { type: 'tonic', tab: [8,8,8,7], suffix: 'm6' },      // Cm6/Eb
                { type: 'dim',   tab: [10,9,10,9], suffix: 'dim7' },  // Fdim7
                { type: 'tonic', tab: [11,10,12,10], suffix: 'm6' },  // Cm6/G
                { type: 'dim',   tab: [13,12,13,12], suffix: 'dim7' },// Abdim7
                { type: 'tonic', tab: [15,13,14,13], suffix: 'm6' },  // Cm6/A
                { type: 'dim',   tab: [16,15,16,15], suffix: 'dim7' } // Bdim7
            ]
        };

        // Configurazione Set Corde
        const STRING_SETS = {
            top:    { name: "Top 4 (1-2-3-4)",    strings: ['string-e', 'string-b', 'string-g', 'string-d'], offsets: [0, 0, 0, 0],    midiBase: [64, 59, 55, 50] },
            middle: { name: "Middle 4 (2-3-4-5)", strings: ['string-b', 'string-g', 'string-d', 'string-a'], offsets: [5, 4, 5, 5],    midiBase: [59, 55, 50, 45] },
            bottom: { name: "Bottom 4 (3-4-5-6)", strings: ['string-g', 'string-d', 'string-a', 'string-E'], offsets: [9, 9, 10, 10],  midiBase: [55, 50, 45, 40] }
        };

        function getNoteName(midiIndex, useSharps) {
            const normalized = (midiIndex % 12 + 12) % 12;
            return useSharps ? NOTES_SHARP[normalized] : NOTES_FLAT[normalized];
        }

        function generateChords(rootName, scaleType) {
            let rootIndex = NOTES_FLAT.indexOf(rootName);
            if (rootIndex === -1) rootIndex = NOTES_SHARP.indexOf(rootName);
            
            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            // Euristica per diesis/bemolli
            const useSharps = ['G', 'D', 'A', 'E', 'B', 'F#', 'C#'].includes(rootName);
            
            const intervals = INTERVALS[scaleType];
            const shapes = REF_SHAPES[scaleType];
            
            return shapes.map((shape, step) => {
                // 1. Calcola Nota della Scala
                const scaleNoteIndex = rootIndex + intervals[step];
                const scaleNoteName = getNoteName(scaleNoteIndex, useSharps);
                
                // 2. Calcola Nome Accordo
                let name = "";
                if (shape.type === 'tonic') {
                    const rootStr = getNoteName(rootIndex, useSharps);
                    name = (step === 0) ? `${rootStr}${shape.suffix}` : `${rootStr}${shape.suffix}/${scaleNoteName}`;
                } else {
                    name = `${scaleNoteName}${shape.suffix}`;
                }
                
                // 3. Calcola Note (Toniche: 1,3,5,6 - Diminuite: 2,4,b6,7)
                const indices = (shape.type === 'tonic') ? [0, 2, 4, 6] : [1, 3, 5, 7];
                const notesList = indices.map(i => {
                    return getNoteName(rootIndex + intervals[i], useSharps);
                }).join('-');
                
                // 4. Calcola Tablatura (Trasposizione + Set Offset)
                // Applica offset del set (es. sposta da corde alte a basse)
                const shapeWithSetOffset = shape.tab.map((f, i) => f + currentSet.offsets[i]);

                let shift = rootIndex; // C=0
                // Se l'accordo va troppo in alto (> tasto 19), abbassa di un'ottava
                const maxFret = Math.max(...shapeWithSetOffset);
                if (maxFret + shift > 19) shift -= 12;
                
                const tab = shapeWithSetOffset.map(f => f + shift);
                
                return { name, type: shape.type, notes: notesList, tab };
            });
        }

        let audioCtx;

        function playChord(chord) {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            // MIDI base dipende dal set
            const baseMidi = currentSet.midiBase;
            const now = audioCtx.currentTime;

            chord.tab.forEach((fret, index) => {
                const midi = baseMidi[index] + fret;
                const freq = 440 * Math.pow(2, (midi - 69) / 12);

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'triangle'; // Suono morbido
                osc.frequency.setValueAtTime(freq, now);

                // Envelope per simulare il pizzico
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.05); 
                gain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start(now);
                osc.stop(now + 2.0);
            });
        }

        async function playScale() {
            // Rigenera la scala per assicurarsi che UI e Audio siano sincronizzati
            renderScale();
            
            const key = document.getElementById('keySelect').value;
            const type = document.getElementById('scaleType').value;
            const chords = generateChords(key, type);
            const cards = document.querySelectorAll('.chord-card');

            for (let i = 0; i < chords.length; i++) {
                const chord = chords[i];
                const card = cards[i];

                // Feedback Visivo: evidenzia la card corrente
                if (card) {
                    card.style.transform = "translateY(-10px)";
                    card.style.borderColor = "#fff";
                }
                
                showTab(chord);
                playChord(chord);

                // Attendi prima del prossimo accordo (800ms)
                await new Promise(r => setTimeout(r, 800));

                // Rimuovi evidenziazione
                if (card) {
                    card.style.transform = "";
                    card.style.borderColor = "";
                }
            }
        }

        function renderScale() {
            const key = document.getElementById('keySelect').value;
            const type = document.getElementById('scaleType').value;
            const container = document.getElementById('scaleGrid');
            
            // Pulisci
            container.innerHTML = '';
            
            const chords = generateChords(key, type);

            // Genera le card
            chords.forEach((chord, index) => {
                const card = document.createElement('div');
                card.className = `chord-card type-${chord.type}`;
                card.innerHTML = `
                    <span class="chord-func">${chord.type === 'tonic' ? 'Home' : 'Tension'}</span>
                    <span class="chord-name">${chord.name}</span>
                    <div class="chord-notes">${chord.notes}</div>
                `;
                
                // Evento click per la tablatura
                card.onclick = () => {
                    showTab(chord);
                    playChord(chord);
                };
                
                container.appendChild(card);
            });
        }

        function drawFretboardGrid() {
            const visualizer = document.getElementById('tab-visualizer');
            if(visualizer.querySelector('.fret-number')) return; // Già disegnata

            for (let i = 0; i <= MAX_FRETS; i++) {
                const left = (i / MAX_FRETS) * 100;
                
                // Linea tasto (escluso capotasto 0 se si vuole, ma mettiamolo per riferimento)
                if (i > 0) {
                    const line = document.createElement('div');
                    line.className = 'fret-line';
                    line.style.left = `${left}%`;
                    visualizer.appendChild(line);
                }
                
                // Numero tasto
                const num = document.createElement('div');
                num.className = 'fret-number';
                num.innerText = i;
                num.style.left = `${left}%`;
                visualizer.appendChild(num);
            }
        }

        function showTab(chord) {
            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];

            document.getElementById('tab-instruction').innerText = `Visualizzando: ${chord.name} (${currentSet.name})`;
            
            // Pulisci tutte le corde
            const allStrings = ['string-e', 'string-b', 'string-g', 'string-d', 'string-a', 'string-E'];
            allStrings.forEach(id => document.getElementById(id).innerHTML = '');
            
            // Disegna nuove note
            const activeStrings = currentSet.strings;

            chord.tab.forEach((fret, index) => {
                const stringDiv = document.getElementById(activeStrings[index]);
                const noteDiv = document.createElement('div');
                noteDiv.className = 'tab-note';
                noteDiv.innerText = fret;
                
                // Posiziona visivamente sul "manico" (percentuale approssimativa per demo)
                // Diciamo che il manico visibile va dal tasto 0 al 18
                let leftPos = (fret / MAX_FRETS) * 100; 
                noteDiv.style.left = leftPos + '%';
                
                stringDiv.appendChild(noteDiv);
            });
        }

        /* --- LOGICA STANZA 2: FAMILY FINDER --- */
        function renderFamily() {
            const parentName = document.getElementById('dimSelect').value;
            const container = document.getElementById('familyGrid');
            container.innerHTML = '';

            // 1. Trova/Genera l'accordo Diminuito Genitore
            // Prendiamo la forma base di Ddim7 (Drop 2 top strings): [7,6,7,6]
            // D è index 2.
            let rootIndex = NOTES_FLAT.indexOf(parentName);
            if (rootIndex === -1) rootIndex = NOTES_SHARP.indexOf(parentName);
            
            // Calcolo shift rispetto a D (index 2)
            let shift = rootIndex - 2; 
            
            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            // Forma base Ddim7
            const baseShape = [7,6,7,6]; 
            // Applica offset set e shift tonica
            let parentTab = baseShape.map((f, i) => f + currentSet.offsets[i] + shift);
            
            // Normalizza ottava (se troppo alto o basso)
            if (Math.max(...parentTab) > 18) parentTab = parentTab.map(f => f - 12);
            if (Math.min(...parentTab) < 0) parentTab = parentTab.map(f => f + 12);

            const parentChord = {
                name: parentName + "dim7",
                type: 'dim',
                notes: "Parent",
                tab: parentTab
            };

            // Render Parent Card
            createCard(parentChord, container, true);

            // 2. Genera i 4 Figli (Dominanti)
            // Regola Barry Harris: Abbassa una nota del diminuito di 1 semitono -> Dominante
            for(let i=0; i<4; i++) {
                const childTab = [...parentTab];
                childTab[i] = childTab[i] - 1; // Abbassa la nota sulla corda i

                // Calcola il nome del Dominante
                // La nota abbassata diventa la Tonica del nuovo accordo dominante
                const stringMidiBase = currentSet.midiBase[i];
                const noteMidi = stringMidiBase + childTab[i];
                const noteName = getNoteName(noteMidi, true); // Usa diesis per semplicità
                
                const childChord = {
                    name: noteName + "7",
                    type: 'tonic', // Usiamo stile tonic per i dominanti qui
                    notes: `String ${i+1} lowered`,
                    tab: childTab
                };
                
                createCard(childChord, container, false);
            }
        }

        function createCard(chord, container, isParent) {
            const card = document.createElement('div');
            card.className = `chord-card ${isParent ? 'type-dim' : 'type-tonic'}`;
            if(isParent) card.style.borderWidth = "4px";
            
            card.innerHTML = `
                <span class="chord-func">${isParent ? 'PARENT' : 'CHILD'}</span>
                <span class="chord-name">${chord.name}</span>
                <div class="chord-notes">${chord.notes}</div>
            `;
            card.onclick = () => { showTab(chord); playChord(chord); };
            container.appendChild(card);
        }

        /* --- LOGICA STANZA 3: RHYTHM BOSS --- */
        let isMetronomeOn = false;
        let metronomeInterval = null;
        let nextNoteTime = 0.0;
        let currentBeat = 0; // 0=1, 1=2, 2=3, 3=4
        let bpm = 100;
        let lookahead = 25.0; // ms
        let scheduleAheadTime = 0.1; // s
        let micAnalyser = null;
        let micStream = null;
        let lastAttackTime = 0;

        function updateBpm(val) {
            bpm = val;
            document.getElementById('bpmDisplay').innerText = val;
        }

        async function toggleMetronome() {
            const btn = document.getElementById('btnMetronome');
            
            if (isMetronomeOn) {
                isMetronomeOn = false;
                btn.innerText = "START SWING";
                clearInterval(metronomeInterval);
                resetVisuals();
                if(micStream) micStream.getTracks().forEach(t => t.stop());
                return;
            }

            // Init Audio & Mic
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(micStream);
                micAnalyser = audioCtx.createAnalyser();
                micAnalyser.fftSize = 512;
                source.connect(micAnalyser);
            } catch (e) {
                console.error("Microfono non disponibile", e);
                alert("Microfono necessario per rilevare gli errori ritmici!");
            }

            isMetronomeOn = true;
            btn.innerText = "STOP";
            currentBeat = 0;
            nextNoteTime = audioCtx.currentTime + 0.1;
            metronomeInterval = setInterval(scheduler, lookahead);
            
            // Avvia loop analisi microfono
            detectRhythmError();
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeat, nextNoteTime);
                nextNote();
            }
        }

        function scheduleNote(beatNumber, time) {
            // beatNumber: 0 (1), 1 (2), 2 (3), 3 (4)
            
            // SUONO: Solo su 2 e 4 (index 1 e 3)
            if (beatNumber === 1 || beatNumber === 3) {
                playHiHat(time);
            }

            // VISUAL: Sincronizza UI
            const delay = (time - audioCtx.currentTime) * 1000;
            setTimeout(() => {
                updateVisualBeat(beatNumber);
            }, delay);
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
            currentBeat = (currentBeat + 1) % 4;
        }

        function playHiHat(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, time);
            osc.frequency.exponentialRampToValueAtTime(4000, time + 0.05); 
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 7000;

            gain.gain.setValueAtTime(0.3, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start(time);
            osc.stop(time + 0.1);
        }

        function updateVisualBeat(beat) {
            for(let i=1; i<=4; i++) document.getElementById(`beat-${i}`).classList.remove('beat-active');
            if (beat === 1 || beat === 3) { 
                document.getElementById(`beat-${beat+1}`).classList.add('beat-active');
            }
        }
        
        function resetVisuals() {
            for(let i=1; i<=4; i++) document.getElementById(`beat-${i}`).classList.remove('beat-active');
        }

        function detectRhythmError() {
            if (!isMetronomeOn || !micAnalyser) return;

            const buffer = new Float32Array(micAnalyser.fftSize);
            micAnalyser.getFloatTimeDomainData(buffer);
            
            let sum = 0;
            for (let i = 0; i < buffer.length; i++) sum += buffer[i] * buffer[i];
            const rms = Math.sqrt(sum / buffer.length);

            if (rms > 0.05) { 
                const now = audioCtx.currentTime;
                if (now - lastAttackTime > 0.2) { 
                    lastAttackTime = now;
                    const secondsPerBeat = 60.0 / bpm;
                    const prevBeatTime = nextNoteTime - secondsPerBeat;
                    const delta = Math.abs(now - prevBeatTime);
                    let actualBeatIndex = (currentBeat - 1 + 4) % 4; 

                    if (now > nextNoteTime - (secondsPerBeat * 0.3)) {
                        actualBeatIndex = currentBeat;
                    }

                    if (actualBeatIndex === 0 || actualBeatIndex === 2) {
                        triggerError();
                    }
                }
            }
            requestAnimationFrame(detectRhythmError);
        }

        function triggerError() {
            document.body.classList.add('flash-error');
            setTimeout(() => document.body.classList.remove('flash-error'), 400);
        }

        function openRoom(roomId) {
            document.querySelectorAll('.room-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`room-${roomId}`).style.display = 'flex';
            document.getElementById(`btn-room-${roomId}`).classList.add('active');
        }

        // Avvia subito in DO all'apertura
        window.onload = () => {
            // Popola select Diminuito
            const dimSelect = document.getElementById('dimSelect');
            NOTES_FLAT.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.innerText = n;
                dimSelect.appendChild(opt);
            });
            dimSelect.value = "C"; // Default

            drawFretboardGrid();
            renderScale();
        };

    </script>
</body>
</html>