<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Barry Harris Logic Engine</title>
    <style>
        /* --- STILE BEBOP (CSS) --- */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --tonic-color: #4CAF50;    /* Verde per la casa/riposo */
            --dim-color: #FF5722;      /* Arancio per la tensione/diminuito */
            --key-white: #e0e0e0;
            --key-black: #333;
        }

        body {
            font-family: 'Courier New', monospace; /* Monospaziato come uno spartito */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--text-color); }
        .subtitle { font-style: italic; opacity: 0.8; margin-bottom: 30px; }

        /* CONTROLLI */
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
            background: #252525;
        }

        select, button {
            padding: 10px 20px;
            font-size: 16px;
            background: var(--key-black);
            color: var(--text-color);
            border: 1px solid #555;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover { background: #444; }

        /* LA GRIGLIA ARMONICA (8 NOTE) */
        .scale-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 steps per la scala BH */
            gap: 10px;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 40px;
        }

        .chord-card {
            background: #333;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
            border-top: 5px solid #555;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .chord-card:hover { transform: translateY(-5px); }

        /* Classi dinamiche per Tensione/Risoluzione */
        .type-tonic { border-top-color: var(--tonic-color); }
        .type-dim { border-top-color: var(--dim-color); }

        .chord-name { font-size: 1.2em; font-weight: bold; display: block; margin-bottom: 5px; }
        .chord-func { font-size: 0.8em; opacity: 0.7; text-transform: uppercase; }
        .chord-notes { font-size: 0.8em; margin-top: 10px; color: #aaa; }

        /* VISUALIZZATORE CHITARRA (TAB) */
        .fretboard-display {
            width: 100%;
            max-width: 600px;
            background: #222;
            padding: 20px;
            border: 1px solid #444;
            position: relative;
        }

        .tab-line {
            border-bottom: 1px solid #666;
            height: 25px;
            position: relative;
            z-index: 5;
        }
        
        .tab-note {
            position: absolute;
            background: var(--text-color);
            color: var(--bg-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            font-size: 12px;
            top: -12px;
            z-index: 10;
        }
        
        #tab-visualizer {
            position: relative;
            padding-bottom: 25px; /* Spazio per i numeri */
        }
        .fret-line {
            position: absolute;
            top: 0;
            height: 150px; /* 6 corde * 25px */
            width: 1px;
            background: #333;
            z-index: 0;
        }
        .fret-number {
            position: absolute;
            top: 105px;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            font-family: sans-serif;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .scale-container { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

    <h1>Bebop Logic Engine</h1>
    <div class="subtitle">"God's logic on a web page. Dig it."</div>

    <div class="controls">
        <label>KEY (TONALITÀ): </label>
        <select id="keySelect">
            <option value="C">C</option>
            <option value="Db">Db</option>
            <option value="D">D</option>
            <option value="Eb">Eb</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="Gb">Gb</option>
            <option value="G">G</option>
            <option value="Ab">Ab</option>
            <option value="A">A</option>
            <option value="Bb">Bb</option>
            <option value="B">B</option>
        </select>
        
        <label>SCALE TYPE: </label>
        <select id="scaleType">
            <option value="major6">Major 6 Diminished</option>
            <option value="minor6">Minor 6 Diminished</option>
        </select>

        <label>STRING SET: </label>
        <select id="stringSet">
            <option value="top">Top 4 (1-2-3-4)</option>
            <option value="middle">Middle 4 (2-3-4-5)</option>
            <option value="bottom">Bottom 4 (3-4-5-6)</option>
        </select>

        <button onclick="renderScale()">CALCULATE LOGIC</button>
    </div>

    <div id="scaleGrid" class="scale-container">
        </div>

    <div class="fretboard-display">
        <h3>DROP 2 VOICING</h3>
        <p id="tab-instruction">Clicca su un accordo sopra per vederlo qui.</p>
        <div id="tab-visualizer">
            <div class="tab-line" id="string-e"></div>
            <div class="tab-line" id="string-b"></div>
            <div class="tab-line" id="string-g"></div>
            <div class="tab-line" id="string-d"></div>
            <div class="tab-line" id="string-a"></div>
            <div class="tab-line" id="string-E"></div>
        </div>
    </div>

    <script>
        /* --- LOGICA BARRY HARRIS (JS) --- */

        // Costanti Musicali
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Intervalli Scale Barry Harris (8 note)
        const INTERVALS = {
            major6: [0, 2, 4, 5, 7, 8, 9, 11], // 1, 2, 3, 4, 5, b6, 6, 7
            minor6: [0, 2, 3, 5, 7, 8, 9, 11]  // 1, 2, b3, 4, 5, b6, 6, 7
        };

        const MAX_FRETS = 20;

        // Forme di Riferimento in DO (C) - Drop 2 (Corde 1-2-3-4)
        const REF_SHAPES = {
            major6: [
                { type: 'tonic', tab: [5,5,5,5], suffix: '6' },       // C6
                { type: 'dim',   tab: [7,6,7,6], suffix: 'dim7' },    // Ddim7
                { type: 'tonic', tab: [8,8,9,7], suffix: '6' },       // C6/E
                { type: 'dim',   tab: [10,9,10,9], suffix: 'dim7' },  // Fdim7
                { type: 'tonic', tab: [12,13,12,10], suffix: '6' },   // C6/G
                { type: 'dim',   tab: [13,12,13,12], suffix: 'dim7' },// Abdim7
                { type: 'tonic', tab: [15,17,14,14], suffix: '6' },   // C6/A
                { type: 'dim',   tab: [16,15,16,15], suffix: 'dim7' } // Bdim7
            ],
            minor6: [
                { type: 'tonic', tab: [5,4,5,5], suffix: 'm6' },      // Cm6
                { type: 'dim',   tab: [7,6,7,6], suffix: 'dim7' },    // Ddim7
                { type: 'tonic', tab: [8,8,8,7], suffix: 'm6' },      // Cm6/Eb
                { type: 'dim',   tab: [10,9,10,9], suffix: 'dim7' },  // Fdim7
                { type: 'tonic', tab: [11,10,12,10], suffix: 'm6' },  // Cm6/G
                { type: 'dim',   tab: [13,12,13,12], suffix: 'dim7' },// Abdim7
                { type: 'tonic', tab: [15,13,14,13], suffix: 'm6' },  // Cm6/A
                { type: 'dim',   tab: [16,15,16,15], suffix: 'dim7' } // Bdim7
            ]
        };

        // Configurazione Set Corde
        const STRING_SETS = {
            top:    { name: "Top 4 (1-2-3-4)",    strings: ['string-e', 'string-b', 'string-g', 'string-d'], offsets: [0, 0, 0, 0],    midiBase: [64, 59, 55, 50] },
            middle: { name: "Middle 4 (2-3-4-5)", strings: ['string-b', 'string-g', 'string-d', 'string-a'], offsets: [5, 4, 5, 5],    midiBase: [59, 55, 50, 45] },
            bottom: { name: "Bottom 4 (3-4-5-6)", strings: ['string-g', 'string-d', 'string-a', 'string-E'], offsets: [9, 9, 10, 10],  midiBase: [55, 50, 45, 40] }
        };

        function getNoteName(midiIndex, useSharps) {
            const normalized = (midiIndex % 12 + 12) % 12;
            return useSharps ? NOTES_SHARP[normalized] : NOTES_FLAT[normalized];
        }

        function generateChords(rootName, scaleType) {
            let rootIndex = NOTES_FLAT.indexOf(rootName);
            if (rootIndex === -1) rootIndex = NOTES_SHARP.indexOf(rootName);
            
            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            // Euristica per diesis/bemolli
            const useSharps = ['G', 'D', 'A', 'E', 'B', 'F#', 'C#'].includes(rootName);
            
            const intervals = INTERVALS[scaleType];
            const shapes = REF_SHAPES[scaleType];
            
            return shapes.map((shape, step) => {
                // 1. Calcola Nota della Scala
                const scaleNoteIndex = rootIndex + intervals[step];
                const scaleNoteName = getNoteName(scaleNoteIndex, useSharps);
                
                // 2. Calcola Nome Accordo
                let name = "";
                if (shape.type === 'tonic') {
                    const rootStr = getNoteName(rootIndex, useSharps);
                    name = (step === 0) ? `${rootStr}${shape.suffix}` : `${rootStr}${shape.suffix}/${scaleNoteName}`;
                } else {
                    name = `${scaleNoteName}${shape.suffix}`;
                }
                
                // 3. Calcola Note (Toniche: 1,3,5,6 - Diminuite: 2,4,b6,7)
                const indices = (shape.type === 'tonic') ? [0, 2, 4, 6] : [1, 3, 5, 7];
                const notesList = indices.map(i => {
                    return getNoteName(rootIndex + intervals[i], useSharps);
                }).join('-');
                
                // 4. Calcola Tablatura (Trasposizione + Set Offset)
                // Applica offset del set (es. sposta da corde alte a basse)
                const shapeWithSetOffset = shape.tab.map((f, i) => f + currentSet.offsets[i]);
                
                let shift = rootIndex; // C=0
                // Se l'accordo va troppo in alto (> tasto 19), abbassa di un'ottava
                const maxFret = Math.max(...shapeWithSetOffset);
                if (maxFret + shift > 19) shift -= 12;
                
                const tab = shapeWithSetOffset.map(f => f + shift);
                
                return { name, type: shape.type, notes: notesList, tab };
            });
        }

        let audioCtx;

        function playChord(chord) {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            // MIDI base dipende dal set
            const baseMidi = currentSet.midiBase;
            const now = audioCtx.currentTime;

            chord.tab.forEach((fret, index) => {
                const midi = baseMidi[index] + fret;
                const freq = 440 * Math.pow(2, (midi - 69) / 12);

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'triangle'; // Suono morbido
                osc.frequency.setValueAtTime(freq, now);

                // Envelope per simulare il pizzico
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.05); 
                gain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start(now);
                osc.stop(now + 2.0);
            });
        }

        function renderScale() {
            const key = document.getElementById('keySelect').value;
            const type = document.getElementById('scaleType').value;
            const container = document.getElementById('scaleGrid');
            
            // Pulisci
            container.innerHTML = '';
            
            const chords = generateChords(key, type);

            // Genera le card
            chords.forEach((chord, index) => {
                const card = document.createElement('div');
                card.className = `chord-card type-${chord.type}`;
                card.innerHTML = `
                    <span class="chord-func">${chord.type === 'tonic' ? 'Home' : 'Tension'}</span>
                    <span class="chord-name">${chord.name}</span>
                    <div class="chord-notes">${chord.notes}</div>
                `;
                
                // Evento click per la tablatura
                card.onclick = () => {
                    showTab(chord);
                    playChord(chord);
                };
                
                container.appendChild(card);
            });
        }

        function drawFretboardGrid() {
            const visualizer = document.getElementById('tab-visualizer');
            if(visualizer.querySelector('.fret-number')) return; // Già disegnata

            for (let i = 0; i <= MAX_FRETS; i++) {
                const left = (i / MAX_FRETS) * 100;
                
                // Linea tasto (escluso capotasto 0 se si vuole, ma mettiamolo per riferimento)
                if (i > 0) {
                    const line = document.createElement('div');
                    line.className = 'fret-line';
                    line.style.left = `${left}%`;
                    visualizer.appendChild(line);
                }
                
                // Numero tasto
                const num = document.createElement('div');
                num.className = 'fret-number';
                num.innerText = i;
                num.style.left = `${left}%`;
                visualizer.appendChild(num);
            }
        }

        function showTab(chord) {
            const setKey = document.getElementById('stringSet').value;
            const currentSet = STRING_SETS[setKey];
            
            document.getElementById('tab-instruction').innerText = `Visualizzando: ${chord.name} (${currentSet.name})`;
            
            // Pulisci tutte le corde (anche quelle non usate)
            const allStrings = ['string-e', 'string-b', 'string-g', 'string-d', 'string-a', 'string-E'];
            allStrings.forEach(id => document.getElementById(id).innerHTML = '');
            
            // Disegna nuove note
            const activeStrings = currentSet.strings;
            
            chord.tab.forEach((fret, index) => {
                const stringDiv = document.getElementById(activeStrings[index]);
                const noteDiv = document.createElement('div');
                noteDiv.className = 'tab-note';
                noteDiv.innerText = fret;
                
                // Posiziona visivamente sul "manico" (percentuale approssimativa per demo)
                // Diciamo che il manico visibile va dal tasto 0 al 18
                let leftPos = (fret / MAX_FRETS) * 100; 
                noteDiv.style.left = leftPos + '%';
                
                stringDiv.appendChild(noteDiv);
            });
        }

        // Avvia subito in DO all'apertura
        window.onload = () => {
            drawFretboardGrid();
            renderScale();
        };

    </script>
</body>
</html>